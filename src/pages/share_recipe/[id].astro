---
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import Main from "../../components/Main.astro";
import { AstroSeo } from '@astrolib/seo';
import { getSharedRecipeById, getRecipeById } from "../../lib/supabase";

console.log('--- Share Recipe Page Execution Start ---');

// Configure SSR for this route
// Using the newer Astro SSR approach
export const prerender = false;

const { id } = Astro.params;
console.log(`Received ID: ${id}`);

// Helper function to ensure a value is an array
function ensureArray(value: any): any[] {
  if (!value) return [];
  if (Array.isArray(value)) return value;
  if (typeof value === 'string') return [value];
  return [value];
}

// Define types for recipe data
interface RecipeIngredient {
  name?: string;
  text?: string;
  [key: string]: any;
}

interface RecipeStep {
  text?: string;
  [key: string]: any;
}

interface RecipeEquipment {
  name?: string;
  [key: string]: any;
}

interface RecipeData {
  title: string;
  description: string;
  prepTime: string;
  servings: number;
  ingredients: RecipeIngredient[] | Record<string, RecipeIngredient[]>;
  instructions: (string | RecipeStep)[];
  equipment: (string | RecipeEquipment)[] | string;
  category?: string;
  cuisine?: string;
  image_url?: string;
  level?: string;
  nutrition_values?: any;
}

interface SharedRecipe {
  id: number;
  created_at?: string;
  expired_at?: string;
  recipe: RecipeData | string;
}

// Try to fetch the recipe from both possible sources
let sharedRecipe: SharedRecipe | null = null;
let fetchError: any = null;
try {
  if (id) {
    console.log(`Attempting to fetch shared recipe with ID: ${id}`);
    sharedRecipe = await getSharedRecipeById(id) as SharedRecipe | null;
    console.log(`Result from getSharedRecipeById: ${sharedRecipe ? 'Found' : 'Not Found'}`);
    
    if (!sharedRecipe) {
      console.log(`Attempting to fetch main recipe with ID: ${id}`);
      // Assuming getRecipeById returns a structure compatible with SharedRecipe or null
      const mainRecipeResult = await getRecipeById(id);
      if (mainRecipeResult) {
        // Adapt the result if necessary, here we assume it might be directly usable or needs wrapping
        // This depends on the actual return type of getRecipeById
        console.log('Found recipe in main table. Adapting structure.');
        sharedRecipe = {
          id: parseInt(id, 10), // Ensure ID is number if needed
          recipe: mainRecipeResult as any, // Cast to any to resolve TS error temporarily
          // Add other fields like created_at, expired_at if available/needed
        };
      } else {
         console.log('Recipe not found in main table either.');
      }
      console.log(`Result from getRecipeById: ${sharedRecipe ? 'Found' : 'Not Found'}`);
    } else {
      console.log('Skipping getRecipeById as shared recipe was found.');
    }
  } else {
    console.log('No ID provided in params.');
  }
} catch (err) {
  console.error('Error during recipe fetch:', err);
  fetchError = err;
}

const hasRecipeData = !!sharedRecipe && !fetchError;
console.log(`hasRecipeData determined as: ${hasRecipeData}`);

// Process recipe data if we have it
let recipe: RecipeData | null = null;
if (hasRecipeData && sharedRecipe) {
  try {
    console.log('Attempting to parse recipe data...');
    // Parse recipe content from the database
    const recipeData = typeof sharedRecipe.recipe === 'string' 
      ? JSON.parse(sharedRecipe.recipe) 
      : sharedRecipe.recipe;
    console.log('Successfully parsed/accessed recipe data.');
    
    // Ensure equipment is always an array
    let equipmentArray: (string | RecipeEquipment)[] = [];
    if (recipeData.equipment) {
      if (Array.isArray(recipeData.equipment)) {
        equipmentArray = recipeData.equipment;
      } else if (typeof recipeData.equipment === 'string') {
        equipmentArray = recipeData.equipment.split(',').map((item: string) => item.trim());
      } else {
        equipmentArray = [recipeData.equipment];
      }
    }
    
    recipe = {
      title: recipeData.title || "Untitled Recipe",
      description: recipeData.description || "",
      prepTime: recipeData.prepTime || recipeData.cookTime || "30 Min",
      servings: recipeData.servings || recipeData.yields || 4,
      ingredients: recipeData.ingredients || [],
      instructions: recipeData.instructions || [],
      equipment: equipmentArray,
      category: recipeData.category,
      cuisine: recipeData.cuisine,
      image_url: recipeData.image_url,
      level: recipeData.level,
      nutrition_values: recipeData.nutrition_values
    };
    console.log('Recipe object processed successfully.');
  } catch (err) {
    console.error("Error parsing recipe data:", err);
    // Keep recipe as null if parsing fails
    recipe = null;
    console.log('Setting recipe to null due to parsing error.');
  }
} else {
  console.log('Skipping recipe processing because hasRecipeData is false or sharedRecipe is null.');
}

// Only create schema if we have recipe data AND the recipe object was successfully processed
let recipeSchema = null;
if (hasRecipeData && recipe) {
  console.log('Attempting to create recipe schema...');
  // Create flattened ingredients list for schema
  let allIngredients: string[] = [];
  if (Array.isArray(recipe.ingredients)) {
    // If ingredients is already a flat array
    allIngredients = recipe.ingredients.map(item => 
      typeof item === 'string' ? item : item.name || item.text || JSON.stringify(item)
    );
  } else if (recipe.ingredients && typeof recipe.ingredients === 'object') {
    // If ingredients is an object with categories
    Object.values(recipe.ingredients).forEach(items => {
      if (Array.isArray(items)) {
        items.forEach(item => {
          allIngredients.push(typeof item === 'string' ? item : item.name || item.text || JSON.stringify(item));
        });
      }
    });
  }

  // Create structured recipe steps for schema
  const recipeSteps = Array.isArray(recipe.instructions) 
    ? recipe.instructions.map((step, index: number) => ({
        "@type": "HowToStep",
        "position": index + 1,
        "text": typeof step === 'string' ? step : step.text || ""
      }))
    : [];

  // Schema.org Recipe schema
  recipeSchema = JSON.stringify({
    "@context": "https://schema.org/",
    "@type": "Recipe",
    "name": recipe.title,
    "description": recipe.description,
    "author": {
      "@type": "Organization",
      "name": "TasteBuddy"
    },
    "image": recipe.image_url || "/images/recipe-preview.png",
    "prepTime": `PT${recipe.prepTime.toString().replace(/[^0-9]/g, '')}M`,
    "cookTime": `PT${recipe.prepTime.toString().replace(/[^0-9]/g, '')}M`,
    "totalTime": `PT${recipe.prepTime.toString().replace(/[^0-9]/g, '')}M`,
    "recipeYield": `${recipe.servings} servings`,
    "recipeCategory": recipe.category || "Main Course",
    "recipeCuisine": recipe.cuisine || "",
    "recipeIngredient": allIngredients,
    "recipeInstructions": recipeSteps,
    "tool": recipe.equipment,
    "publisher": {
      "@type": "Organization",
      "name": "TasteBuddy",
      "logo": {
        "@type": "ImageObject",
        "url": "https://taste-buddy.app/images/logo.png"
      }
    },
    "datePublished": sharedRecipe?.created_at || new Date().toISOString().split('T')[0]
  });
  console.log('Recipe schema created.');
} else {
  console.log('Skipping schema creation.');
}

// Generic page title and description
const pageTitle = (hasRecipeData && recipe) ? `${recipe.title} - TasteBuddy Recipe` : "Recipe Not Found - TasteBuddy";
const pageDescription = (hasRecipeData && recipe) ? recipe.description : "Sorry, the recipe you are looking for could not be found or may have expired.";
console.log(`Final page title set to: ${pageTitle}`);

console.log('--- Share Recipe Page Execution End ---');
---

<AstroSeo
  title={pageTitle}
  description={pageDescription}
  openGraph={{
    title: hasRecipeData && recipe ? `${recipe.title} - Save this recipe to TasteBuddy` : "Discover recipes with TasteBuddy",
    description: pageDescription,
    images: [{ url: recipe?.image_url || '/images/recipe-preview.png' }],
  }}
/>

{recipeSchema && (
  <script type="application/ld+json" set:html={recipeSchema}></script>
)}

<Layout title={pageTitle}>
  <Main>
    <section class="relative overflow-hidden py-8 sm:py-12">
      <div class="max-w-3xl mx-auto px-4 sm:px-6">
        
        {hasRecipeData && recipe ? (
          <>
            <!-- Recipe Header -->
            <div class="text-center mb-8">
              <span class="inline-block text-xl mb-2">üç≥</span>
              <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">{recipe.title}</h1>
              <p class="text-lg text-gray-300 mb-6">{recipe.description}</p>
              
              <!-- Recipe Meta Info -->
              <div class="flex flex-wrap justify-center gap-6 mb-6">
                {recipe.prepTime && (
                  <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-3 rounded-lg border border-[#2A2D24]/30 backdrop-blur-sm">
                    <span class="text-sm text-gray-400">‚è±Ô∏è Kochzeit</span>
                    <p class="text-white font-medium">{recipe.prepTime}</p>
                  </div>
                )}
                {recipe.servings && (
                  <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-3 rounded-lg border border-[#2A2D24]/30 backdrop-blur-sm">
                    <span class="text-sm text-gray-400">üë• Portionen</span>
                    <p class="text-white font-medium">{recipe.servings}</p>
                  </div>
                )}
                {recipe.level && (
                  <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-3 rounded-lg border border-[#2A2D24]/30 backdrop-blur-sm">
                    <span class="text-sm text-gray-400">üî• Schwierigkeit</span>
                    <p class="text-white font-medium capitalize">{recipe.level}</p>
                  </div>
                )}
              </div>
            </div>
            
            <!-- Recipe Image (if available) -->
            {recipe.image_url && (
              <div class="mb-8 rounded-xl overflow-hidden">
                <img 
                  src={recipe.image_url} 
                  alt={`Photo of ${recipe.title}`} 
                  class="w-full h-auto"
                />
              </div>
            )}
            
            <!-- Recipe Content -->
            <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-6 sm:p-8 rounded-2xl border border-[#2A2D24]/30 backdrop-blur-sm mb-8">
              
              <!-- Ingredients -->
              {recipe.ingredients && (Array.isArray(recipe.ingredients) ? recipe.ingredients.length > 0 : Object.keys(recipe.ingredients).length > 0) && (
                <div class="mb-8">
                  <h2 class="text-2xl font-bold text-white mb-4">üìù Zutaten</h2>
                  
                  {/* Handle different ingredient structures */}
                  {Array.isArray(recipe.ingredients) ? (
                    <ul class="space-y-1">
                      {recipe.ingredients.map((item: string | RecipeIngredient) => (
                        <li class="text-gray-300">‚Ä¢ {typeof item === 'string' ? item : item.name || item.text || JSON.stringify(item)}</li>
                      ))}
                    </ul>
                  ) : recipe.ingredients && typeof recipe.ingredients === 'object' ? (
                    Object.entries(recipe.ingredients).map(([category, items]) => (
                      <div class="mb-4">
                        <h3 class="text-xl font-semibold text-white mb-2">üìù {category}</h3>
                        <ul class="space-y-1">
                          {Array.isArray(items) && items.map((item: string | RecipeIngredient) => (
                            <li class="text-gray-300">‚Ä¢ {typeof item === 'string' ? item : item.name || item.text || JSON.stringify(item)}</li>
                          ))}
                        </ul>
                      </div>
                    ))
                  ) : null}
                </div>
              )}
              
              <!-- Instructions -->
              {recipe.instructions && recipe.instructions.length > 0 && (
                <div class="mb-8">
                  <h2 class="text-2xl font-bold text-white mb-4">üë©‚Äçüç≥ Zubereitung</h2>
                  <ol class="space-y-3">
                    {recipe.instructions.map((step: string | RecipeStep, index: number) => (
                      <li class="text-gray-300">
                        <span class="font-bold text-white">{index + 1}.</span> {typeof step === 'string' ? step : step.text || JSON.stringify(step)}
                      </li>
                    ))}
                  </ol>
                </div>
              )}
              
              <!-- Equipment -->
              {recipe?.equipment && (
                <div class="mb-8">
                  <h2 class="text-2xl font-bold text-white mb-4">üîß K√ºchenger√§te</h2>
                  <ul class="space-y-1">
                    {ensureArray(recipe.equipment).map((item: string | RecipeEquipment) => (
                      <li class="text-gray-300">‚Ä¢ {typeof item === 'string' ? item : item.name || JSON.stringify(item)}</li>
                    ))}
                  </ul>
                </div>
              )}
              
              <!-- Nutrition Information (if available) -->
              {recipe.nutrition_values && Object.keys(recipe.nutrition_values).length > 0 && (
                <div>
                  <h2 class="text-2xl font-bold text-white mb-4">ü•ó N√§hrwerte</h2>
                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    {Object.entries(recipe.nutrition_values).map(([key, value]) => (
                      <div class="bg-[#1C2513]/50 p-2 rounded">
                        <p class="text-sm text-gray-400 capitalize">{key}</p>
                        <p class="text-white font-medium">{value}</p>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </>
        ) : (
          <!-- Fallback Page for when recipe is not found -->
          <div class="text-center mb-8">
            <span class="inline-block text-6xl mb-6">üç≥</span>
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-6">Rezept nicht gefunden</h1>
            <p class="text-xl text-gray-300 mb-6">Dieses Rezept ist nicht mehr verf√ºgbar oder wurde gel√∂scht.</p>
            
            <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-6 sm:p-8 rounded-2xl border border-[#2A2D24]/30 backdrop-blur-sm mb-8">
              <h2 class="text-2xl font-bold text-white mb-4">Entdecke tausende Rezepte mit TasteBuddy</h2>
              <p class="text-lg text-gray-300 mb-6">
                Mit TasteBuddy kannst du:
              </p>
              <ul class="text-left text-gray-200 mb-6 space-y-2">
                <li class="flex items-start">
                  <span class="text-[#00CE31] mr-2">‚úì</span> 
                  <span>Rezepte von √ºberall im Internet speichern</span>
                </li>
                <li class="flex items-start">
                  <span class="text-[#00CE31] mr-2">‚úì</span> 
                  <span>Automatische Einkaufslisten erstellen</span>
                </li>
                <li class="flex items-start">
                  <span class="text-[#00CE31] mr-2">‚úì</span> 
                  <span>Rezepte mit Freunden und Familie teilen</span>
                </li>
                <li class="flex items-start">
                  <span class="text-[#00CE31] mr-2">‚úì</span> 
                  <span>Deine Lieblingsrezepte immer griffbereit haben</span>
                </li>
              </ul>
            </div>
          </div>
        )}
        
        <!-- CTA Banner (always shown) -->
        <div class="bg-gradient-to-r from-[#00CE31]/40 to-[#00CE31]/30 rounded-xl p-6 sm:p-8 text-center backdrop-blur-sm border border-[#00CE31]/30">
          <h2 class="text-xl sm:text-2xl font-bold text-white mb-3">
            {hasRecipeData && recipe ? "Dieses Rezept speichern" : "TasteBuddy herunterladen"}
          </h2>
          <p class="text-gray-200 mb-6">
            {hasRecipeData && recipe 
              ? "Speichern Sie dieses Rezept in TasteBuddy, um es jederzeit offline zu finden, m√ºhelos einzukaufen und mit Freunden zu teilen."
              : "Lade dir TasteBuddy herunter, um Rezepte zu speichern, zu organisieren und zu teilen. Nie wieder verlorene Rezepte!"
            }
          </p>
          
          <div class="flex flex-wrap justify-center gap-4">
            <a 
              href="https://apps.apple.com/app/id6554007741"
              aria-label="Download TasteBuddy on the App Store"
              class="transform transition-transform duration-300 hover:scale-105"
              target="_blank" 
              rel="noopener noreferrer"
            >
              <img
                src="/images/Download_on_the_App_Store_Badge_US-UK_RGB_blk_092917.svg"
                alt="Download TasteBuddy on the App Store"
                class="h-12"
              />
            </a>
            <a 
              href="https://play.google.com/store/apps/details?id=app.tastebuddy"
              aria-label="Download TasteBuddy on Google Play"
              class="transform transition-transform duration-300 hover:scale-105"
              target="_blank" 
              rel="noopener noreferrer"
            >
              <img
                src="/images/Google_Play_Badge.png"
                alt="Download TasteBuddy on Google Play"
                class="h-12"
              />
            </a>
          </div>
          
          <div class="mt-6 text-sm text-gray-300">
            <p>Oder √∂ffnen Sie diesen Link in der App:</p>
            <a href={`https://taste-buddy.app/share_recipe/${id}`} class="text-[#00CE31] underline mt-1 inline-block">
              taste-buddy.app/share_recipe/{id}
            </a>
          </div>
        </div>
      </div>
    </section>
  </Main>
</Layout> 