---
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import Main from "../../components/Main.astro";
import { AstroSeo } from '@astrolib/seo';

// Use server-side rendering instead of static generation
export const prerender = false;

const { id } = Astro.params;

// In a real implementation, we would fetch recipe data here
// For now, we'll use a simple check to see if we have data for this ID
const hasRecipeData = id === '82'; // In production, this would be a database check

// Recipe data only used if hasRecipeData is true
const recipe = hasRecipeData ? {
  title: "ASIATISCHER FRIED RICE",
  description: "Das Rezept f√ºr den Asiatischen Fried Rice verspricht immer dann gro√üen Genuss, wenn sich der Appetit auf gesunde und leichte Mahlzeit meldet.",
  prepTime: "20 Min",
  servings: 4,
  ingredients: [
    {
      category: "Vorbereitung Gem√ºse",
      items: [
        "1.0Stk Chinakohl",
        "3.0Stk Karotten",
        "3.0cm Ingwer",
        "2.0Stk Knoblauchzehen",
        "2.0Stk Paprika",
      ]
    },
    {
      category: "Zubereitung Asiatischer Fried Rice",
      items: [
        "250.0g Basmatireis",
        "1.0TL Chiliflocken",
        "2.0Stk Eier",
        "2.0EL Erdn√ºsse",
        "0.5Stk Limette",
        "2.0EL Sesam√∂l",
        "2.0Spr Sojasauce",
      ]
    }
  ],
  instructions: [
    "Vorbereitung Gem√ºse:",
    "Zuerst den Chinakohl putzen, unter flie√üendem Wasser abwaschen, halbieren und bis auf den festen Strunk in schmale Streifen schneiden.",
    "Anschlie√üend die Karotten waschen, mit einem Sparsch√§ler sch√§len und in feine Stifte schneiden. Den Ingwerund den Knoblauch sch√§len und fein hacken.",
    "Danach die Paprikas halbieren, die Kerne entfernen, waschen und die Schoten ebenfalls in feine Streifen schneiden. Zubereitung Asiatischer Fried Rice:",
    "Nun 2 TL Sesam√∂l in einem Wok (oder einer tiefen Pfanne) erhitzen und den Kohl, die Karotten sowie den Paprika kurz und kr√§ftig darin anbraten.",
    "Sobald der Kohl zusammengefallen ist, das ganze Gem√ºse aus dem Wok in eine Sch√ºssel umf√ºllen.",
    "Nun das restliche √ñl im Wok erhitzen, den Ingwer und den Knoblauch darin glasig anbraten und anschlie√üend am Rand etwas hochschieben.",
    "Die Eier in einer kleinen Sch√ºssel verquirlen, in die Mitte des Woks geben, kurz verr√ºhren und ebenfalls am Rand hochschieben.",
    "Jetzt den kalten Reis hinzuf√ºgen, mit dem gestockten Ei, Ingwer sowie Knoblauch verr√ºhren und braten. Dabei nur ab und zu wenden, damit der Reis knusprig werden kann.",
    "Inzwischen die Limette auspressen, dann den Saft mit der Sojasauce und den Chiliflocken vermischen und unter die Zutaten im Wok r√ºhren.",
    "Zuletzt das Gem√ºse zur√ºck in den Wok geben, alles gut vermengen, nochmals erhitzen und den Asiatischen Fried Rice vor dem Servieren mit den Erdn√ºssen bestreuen."
  ],
  equipment: ["Wok oder tiefe Pfanne"]
} : null;

// Only create schema if we have recipe data
let recipeSchema = null;
if (hasRecipeData && recipe) {
  // Create flattened ingredients list for schema
  const allIngredients = recipe.ingredients.flatMap(category => category.items);

  // Create structured recipe steps for schema
  const recipeSteps = recipe.instructions.slice(1).map((step, index) => ({
    "@type": "HowToStep",
    "position": index + 1,
    "text": step
  }));

  // Schema.org Recipe schema
  recipeSchema = JSON.stringify({
    "@context": "https://schema.org/",
    "@type": "Recipe",
    "name": recipe.title,
    "description": recipe.description,
    "author": {
      "@type": "Organization",
      "name": "TasteBuddy"
    },
    "image": "/images/recipe-preview.png",
    "prepTime": `PT${recipe.prepTime.replace(' Min', '')}M`,
    "cookTime": `PT${recipe.prepTime.replace(' Min', '')}M`,
    "totalTime": `PT${recipe.prepTime.replace(' Min', '')}M`,
    "recipeYield": `${recipe.servings} servings`,
    "recipeCategory": "Main Course",
    "recipeCuisine": "Asian",
    "recipeIngredient": allIngredients,
    "recipeInstructions": recipeSteps,
    "tool": recipe.equipment,
    "nutrition": {
      "@type": "NutritionInformation",
      "servingSize": "1 portion"
    },
    "publisher": {
      "@type": "Organization",
      "name": "TasteBuddy",
      "logo": {
        "@type": "ImageObject",
        "url": "https://taste-buddy.app/images/logo.png"
      }
    },
    "datePublished": new Date().toISOString().split('T')[0]
  });
}

// Generic page title and description for when we don't have recipe data
const pageTitle = hasRecipeData && recipe ? `${recipe.title} - TasteBuddy Recipe` : "TasteBuddy Recipe";
const pageDescription = hasRecipeData && recipe ? recipe.description : "Entdecke leckere Rezepte mit TasteBuddy - der ultimativen App f√ºr Rezeptorganisation und Kochen.";
---

<AstroSeo
  title={pageTitle}
  description={pageDescription}
  openGraph={{
    title: hasRecipeData && recipe ? `${recipe.title} - Save this recipe to TasteBuddy` : "Discover recipes with TasteBuddy",
    description: pageDescription,
    images: [{ url: '/images/recipe-preview.png' }],
  }}
/>

{recipeSchema && (
  <script type="application/ld+json" set:html={recipeSchema}></script>
)}

<Layout title={pageTitle}>
  <Main>
    <section class="relative overflow-hidden py-8 sm:py-12">
      <div class="max-w-3xl mx-auto px-4 sm:px-6">
        
        {hasRecipeData && recipe ? (
          <>
            <!-- Recipe Header -->
            <div class="text-center mb-8">
              <span class="inline-block text-xl mb-2">üç≥</span>
              <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">{recipe.title}</h1>
              <p class="text-lg text-gray-300 mb-6">{recipe.description}</p>
              
              <!-- Recipe Meta Info -->
              <div class="flex flex-wrap justify-center gap-6 mb-6">
                <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-3 rounded-lg border border-[#2A2D24]/30 backdrop-blur-sm">
                  <span class="text-sm text-gray-400">‚è±Ô∏è Kochzeit</span>
                  <p class="text-white font-medium">{recipe.prepTime}</p>
                </div>
                <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-3 rounded-lg border border-[#2A2D24]/30 backdrop-blur-sm">
                  <span class="text-sm text-gray-400">üë• Portionen</span>
                  <p class="text-white font-medium">{recipe.servings}</p>
                </div>
              </div>
            </div>
            
            <!-- Recipe Content -->
            <div class="bg-gradient-to-br from-[#1C2513]/90 to-[#1C2513]/80 p-6 sm:p-8 rounded-2xl border border-[#2A2D24]/30 backdrop-blur-sm mb-8">
              
              <!-- Ingredients -->
              <div class="mb-8">
                <h2 class="text-2xl font-bold text-white mb-4">üìù Zutaten</h2>
                {recipe.ingredients.map(category => (
                  <div class="mb-4">
                    <h3 class="text-xl font-semibold text-white mb-2">üìù {category.category}</h3>
                    <ul class="space-y-1">
                      {category.items.map(item => (
                        <li class="text-gray-300">‚Ä¢ {item}</li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
              
              <!-- Instructions -->
              <div class="mb-8">
                <h2 class="text-2xl font-bold text-white mb-4">üë©‚Äçüç≥ Zubereitung</h2>
                <ol class="space-y-3">
                  {recipe.instructions.map((step, index) => (
                    <li class="text-gray-300">
                      {index !== 0 && <span class="font-bold text-white">{index}.</span>} {step}
                    </li>
                  ))}
                </ol>
              </div>
              
              <!-- Equipment -->
              <div>
                <h2 class="text-2xl font-bold text-white mb-4">üîß K√ºchenger√§te</h2>
                <ul class="space-y-1">
                  {recipe.equipment.map(item => (
                    <li class="text-gray-300">‚Ä¢ {item}</li>
                  ))}
                </ul>
              </div>
            </div>
          </>
        ) : (
          <!-- Generic Recipe Info when no specific data -->
          <div class="text-center mb-8">
            <span class="inline-block text-4xl mb-4">üç≥</span>
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-4">Entdecke dieses Rezept</h1>
            <p class="text-lg text-gray-300 mb-6">Lade TasteBuddy herunter, um dieses und tausende andere Rezepte zu entdecken, zu speichern und mit Freunden zu teilen.</p>
          </div>
        )}
        
        <!-- CTA Banner (always shown) -->
        <div class="bg-gradient-to-r from-[#00CE31]/40 to-[#00CE31]/30 rounded-xl p-6 sm:p-8 text-center backdrop-blur-sm border border-[#00CE31]/30">
          <h2 class="text-xl sm:text-2xl font-bold text-white mb-3">
            {hasRecipeData && recipe ? "Dieses Rezept speichern" : "Rezepte entdecken und speichern"}
          </h2>
          <p class="text-gray-200 mb-6">
            {hasRecipeData && recipe 
              ? "Speichern Sie dieses Rezept in TasteBuddy, um es jederzeit offline zu finden, m√ºhelos einzukaufen und mit Freunden zu teilen."
              : "Mit TasteBuddy k√∂nnen Sie Rezepte importieren, organisieren und teilen. Nie wieder verlorene Rezepte!"
            }
          </p>
          
          <div class="flex flex-wrap justify-center gap-4">
            <a 
              href="https://apps.apple.com/app/id6554007741"
              aria-label="Download TasteBuddy on the App Store"
              class="transform transition-transform duration-300 hover:scale-105"
              target="_blank" 
              rel="noopener noreferrer"
            >
              <img
                src="/images/Download_on_the_App_Store_Badge_US-UK_RGB_blk_092917.svg"
                alt="Download TasteBuddy on the App Store"
                class="h-12"
              />
            </a>
            <a 
              href="https://play.google.com/store/apps/details?id=app.tastebuddy"
              aria-label="Download TasteBuddy on Google Play"
              class="transform transition-transform duration-300 hover:scale-105"
              target="_blank" 
              rel="noopener noreferrer"
            >
              <img
                src="/images/Google_Play_Badge.png"
                alt="Download TasteBuddy on Google Play"
                class="h-12"
              />
            </a>
          </div>
          
          <div class="mt-6 text-sm text-gray-300">
            <p>Oder √∂ffnen Sie diesen Link in der App:</p>
            <a href={`https://taste-buddy.app/share_recipe/${id}`} class="text-[#00CE31] underline mt-1 inline-block">
              taste-buddy.app/share_recipe/{id}
            </a>
          </div>
        </div>
      </div>
    </section>
  </Main>
</Layout> 