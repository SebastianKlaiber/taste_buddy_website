[build]
  command = "npm run netlify-build"
  publish = "dist"

# Configure environment variables
[build.environment]
  NODE_VERSION = "18.20.0"
  NPM_VERSION = "9.8.1"
  NODE_ENV = "production"
  ROLLUP_SKIP_NODEJS = "true"
  NPM_CONFIG_LEGACY_PEER_DEPS = "true"
  SECRETS_SCAN_OMIT_KEYS = "PUBLIC_SUPABASE_URL,PUBLIC_SUPABASE_ANON_KEY"
  # Make it clearer where build outputs go for debugging
  DEBUG = "astro:*"
  # Disable log output hiding to help debug build issues
  NETLIFY_EXPERIMENTAL_BUILD_LOGS_HIDE_POTENTIAL_SECRETS = "false"

# Function configuration
[functions]
  node_bundler = "esbuild"
  # Ensure this points to the correct directory where functions are generated
  directory = ".netlify/functions"

[[plugins]]
  package = "@netlify/plugin-emails"

# Tell Netlify where to find our custom 404 page
[build.processing]
  skip_processing = false
[build.processing.html]
  pretty_urls = true

# Static assets - Ensure Astro's assets are served correctly
[[redirects]]
  from = "/_astro/*"
  to = "/_astro/:splat"
  status = 200

# Server-side rendered routes for share_recipe - catch the dynamic route for the ID
# This MUST come before the general /* catch-all
[[redirects]]
  from = "/share_recipe/:id"
  to = "/.netlify/functions/ssr"
  status = 200
  force = true # Always force this redirect to ensure it works

# Specific redirect for the main page (root path) - keep if needed
# [[redirects]]
#   from = "/"
#   to = "/index.html"
#   status = 200

# Catch-all: Route all other requests to the Astro SSR function
# This replaces the previous /* rule that pointed to 404.html
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/ssr"
  status = 200
